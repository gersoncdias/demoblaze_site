name: CI/CD Pipeline

on:
  push:
    branches:
      - qa
  repository_dispatch:  # Captura eventos enviados pelo repositório de automação.
    types:
      - tests-passed

jobs:
  build-and-test:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout do código
        uses: actions/checkout@v2

      - name: Configurar Docker Buildx
        uses: docker/setup-buildx-action@v2

      - name: Instalar Docker Compose
        run: |
          sudo apt-get update
          sudo apt-get install -y docker-compose

      - name: Build e Deploy
        run: |
          echo "Deploy para QA na porta 8000"
          docker-compose down
          docker-compose up -d --build

      - name: Disparar Pipeline de Automação
        run: |
          echo "Disparando pipeline de automação no repositório demoblaze_hm"
          curl -X POST -H "Authorization: token ${{ secrets.PERSONAL_ACCESS_TOKEN }}" \
          -H "Accept: application/vnd.github.everest-preview+json" \
          https://api.github.com/repos/gersoncdias/demoblaze_hm/dispatches \
          -d '{"event_type": "run-tests"}'

  merge-to-main:
    # Remove a dependência de build-and-test, já que será acionado diretamente pelo evento repository_dispatch.
    runs-on: ubuntu-latest
    if: github.event.action == 'tests-passed'  # Confirma que o evento é do tipo tests-passed.

    steps:
      - name: Checkout do código
        uses: actions/checkout@v2
        with:
          fetch-depth: 0  # Busca todas as branches para realizar o merge.

      - name: Configurar Git para o Merge
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

      - name: Merge para Produção
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git checkout main  # Faz checkout na branch main.
          git merge qa --no-ff -m "Merge automático de QA para Main"  # Realiza o merge.
          git push origin main  # Faz push do merge para o repositório remoto.
